class Game{constructor(){Detector.webgl||Detector.addGetWebGLMessage(),this.modes=Object.freeze({NONE:Symbol("none"),PRELOAD:Symbol("preload"),INITIALISING:Symbol("initialising"),CREATING_LEVEL:Symbol("creating_level"),ACTIVE:Symbol("active"),GAMEOVER:Symbol("gameover")}),this.mode=this.modes.NONE,this.container,this.player,this.cameras,this.camera,this.scene,this.renderer,this.animations={},this.assetsPath="assets/",this.remotePlayers=[],this.remoteColliders=[],this.initialisingPlayers=[],this.remoteData=[],this.messages={text:["Welcome to Blockland","GOOD LUCK!"],index:0},this.localForward=0,this.localTurn=0,this.upPressed=!1,this.downPressed=!1,this.leftPressed=!1,this.rightPressed=!1,this.container=document.createElement("div"),this.container.style.height="100%",document.body.appendChild(this.container);SFX.supportsAudioType("mp3");const e=this;this.anims=["hazmatWalking","hazmatWalking Backwards","hazmatTurn","hazmatRunning","hazmatPointing","hazmatTalking","hazmatPointing Gesture","mocapWalking","mocapWalking Backwards","mocapTurn","mocapRunning","mocapPointing","mocapTalking","mocapPointing Gesture"];const t={assets:[`${this.assetsPath}images/nx.jpg`,`${this.assetsPath}images/px.jpg`,`${this.assetsPath}images/ny.jpg`,`${this.assetsPath}images/py.jpg`,`${this.assetsPath}images/nz.jpg`,`${this.assetsPath}images/pz.jpg`],oncomplete:function(){e.init()}};this.anims.forEach(function(e){t.assets.push(`https://virtual-event-space.s3-eu-west-1.amazonaws.com/${e}.fbx`)}),t.assets.push("https://virtual-event-space.s3-eu-west-1.amazonaws.com/house.fbx"),this.mode=this.modes.PRELOAD,this.clock=new THREE.Clock;new Preloader(t);window.onError=function(e){console.error(JSON.stringify(e))}}initSfx(){this.sfx={},this.sfx.context=new(window.AudioContext||window.webkitAudioContext),this.sfx.gliss=new SFX({context:this.sfx.context,src:{mp3:`${this.assetsPath}sfx/gliss.mp3`,ogg:`${this.assetsPath}sfx/gliss.ogg`},loop:!1,volume:.3})}set activeCamera(e){this.cameras.active=e}init(){this.mode=this.modes.INITIALISING,this.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,10,2e5),this.scene=new THREE.Scene,this.scene.background=new THREE.Color(41200);const e=new THREE.AmbientLight(11184810);this.scene.add(e);const t=new THREE.DirectionalLight(11184810);t.position.set(30,100,40),t.target.position.set(0,0,0),t.castShadow=!0;t.shadow.camera.near=1,t.shadow.camera.far=500,t.shadow.camera.left=t.shadow.camera.bottom=-500,t.shadow.camera.right=t.shadow.camera.top=500,t.shadow.bias=.0039,t.shadow.mapSize.width=1024,t.shadow.mapSize.height=1024,this.sun=t,this.scene.add(t);const i=new THREE.FBXLoader,s=this;this.player=new PlayerLocal(this),this.loadEnvironment(i),this.speechBubble=new SpeechBubble(this,"",150),this.speechBubble.mesh.position.set(0,350,0),this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.container.appendChild(this.renderer.domElement),"ontouchstart"in window?window.addEventListener("touchdown",e=>s.onMouseDown(e),!1):window.addEventListener("mousedown",e=>s.onMouseDown(e),!1),window.addEventListener("keydown",e=>s.onKeyDown(e),!1),window.addEventListener("keyup",e=>s.onKeyUp(e),!1),window.addEventListener("keypress",e=>s.onKeyPress(e),!1),window.addEventListener("resize",()=>s.onWindowResize(),!1)}loadEnvironment(e){const t=this;e.load("https://virtual-event-space.s3-eu-west-1.amazonaws.com/house.fbx",function(i){t.environment=i,t.colliders=[],t.scene.add(i),i.traverse(function(e){e.isMesh&&(e.name.startsWith("proxy")?(t.colliders.push(e),e.material.visible=!1):(e.castShadow=!0,e.receiveShadow=!0))});const s=new THREE.CubeTextureLoader;s.setPath(`${t.assetsPath}/images/`);var o=s.load(["px.jpg","nx.jpg","py.jpg","ny.jpg","pz.jpg","nz.jpg"]);t.scene.background=o,t.loadNextAnim(e)})}loadNextAnim(e){let t=this.anims.pop();const i=this;e.load(`https://virtual-event-space.s3-eu-west-1.amazonaws.com/${t}.fbx`,function(s){i.player.animations[t]=s.animations[0],i.anims.length>0?i.loadNextAnim(e):(delete i.anims,i.action="Idle",i.mode=i.modes.ACTIVE,i.animate())})}playerControl(e,t){t=-t,e>.3?"Walking"!=this.player.action&&"Running"!=this.player.action&&(this.player.action="Walking"):e<-.3?"Walking Backwards"!=this.player.action&&(this.player.action="Walking Backwards"):(e=0,Math.abs(t)>.1?"Turn"!=this.player.action&&(this.player.action="Turn"):"Idle"!=this.player.action&&(this.player.action="Idle")),0==e&&0==t?delete this.player.motion:this.player.motion={forward:e,turn:t},this.player.updateSocket()}createCameras(){new THREE.Vector3(0,80,0);const e=new THREE.Object3D;e.position.set(112,100,600),e.parent=this.player.object;const t=new THREE.Object3D;t.position.set(0,150,-500),t.parent=this.player.object;const i=new THREE.Object3D;i.position.set(0,200,-450),i.parent=this.player.object;const s=new THREE.Object3D;s.position.set(178,139,1665),s.parent=this.player.object;const o=new THREE.Object3D;o.position.set(0,400,0),o.parent=this.player.object;const a=new THREE.Object3D;a.position.set(40,82,94),a.parent=this.player.object,this.cameras={front:e,back:t,wide:s,overhead:o,collect:a,chat:i},this.activeCamera=this.cameras.back}showMessage(e,t=20,i=null){const s=document.getElementById("message_text");s.innerHTML=e,s.style.fontSize=t+"px";const o=document.getElementById("message_ok"),a=document.getElementById("message"),n=this;o.onclick=null!=i?function(){a.style.display="none",i.call(n)}:function(){a.style.display="none"},a.style.display="flex"}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}updateRemotePlayers(e){if(void 0===this.remoteData||0==this.remoteData.length||void 0===this.player||void 0===this.player.id)return;const t=this,i=[],s=[];this.remoteData.forEach(function(e){if(t.player.id!=e.id){let o;if(t.initialisingPlayers.forEach(function(t){t.id==e.id&&(o=t)}),void 0===o){let o;t.remotePlayers.forEach(function(t){t.id==e.id&&(o=t)}),void 0===o?t.initialisingPlayers.push(new Player(t,e)):(i.push(o),s.push(o.collider))}}}),this.scene.children.forEach(function(e){e.userData.remotePlayer&&null==t.getRemotePlayerById(e.userData.id)&&t.scene.remove(e)}),this.remotePlayers=i,this.remoteColliders=s,this.remotePlayers.forEach(function(t){t.update(e)})}onMouseDown(e){if(void 0===this.remoteColliders||0==this.remoteColliders.length||void 0===this.speechBubble||void 0===this.speechBubble.mesh)return;const t=new THREE.Vector2;t.x=e.clientX/this.renderer.domElement.clientWidth*2-1,t.y=-e.clientY/this.renderer.domElement.clientHeight*2+1;const i=new THREE.Raycaster;i.setFromCamera(t,this.camera);const s=i.intersectObjects(this.remoteColliders),o=document.getElementById("chat");if(s.length>0){const e=s[0].object,t=this.remotePlayers.filter(function(t){if(void 0!==t.collider&&t.collider==e)return!0});if(t.length>0){const e=t[0];console.log(`onMouseDown: player ${e.id}`),this.speechBubble.player=e,this.speechBubble.update(""),this.scene.add(this.speechBubble.mesh),this.chatSocketId=e.id,o.style.bottom="0px",this.activeCamera=this.cameras.chat}}else"0px"==o.style.bottom&&window.innerHeight-e.clientY>40?(console.log("onMouseDown: No player found"),null!==this.speechBubble.mesh.parent&&this.speechBubble.mesh.parent.remove(this.speechBubble.mesh),delete this.speechBubble.player,delete this.chatSocketId,o.style.bottom="-50px",this.activeCamera=this.cameras.back):console.log("onMouseDown: typing")}onKeyDown(e){var t=e.which;87==t&&(this.upPressed=!0),83==t&&(this.downPressed=!0),65==t&&(this.leftPressed=!0),68==t&&(this.rightPressed=!0),this.upPressed&&(game.localForward=1),this.downPressed&&(game.localForward=-1),this.leftPressed&&(game.localTurn=-1),this.rightPressed&&(game.localTurn=1),87!=t&&83!=t&&65!=t&&68!=t||this.playerControl(game.localForward,game.localTurn),49==t&&(this.player.action="Pointing Gesture")}onKeyUp(e){var t=e.which;87==t&&(this.upPressed=!1,game.localForward=0),83==t&&(this.downPressed=!1,game.localForward=0),65==t&&(this.leftPressed=!1,game.localTurn=0),68==t&&(this.rightPressed=!1,game.localTurn=0),this.upPressed&&(game.localForward=1),this.downPressed&&(game.localForward=-1),this.leftPressed&&(game.localTurn=-1),this.rightPressed&&(game.localTurn=1),this.playerControl(game.localForward,game.localTurn)}onKeyPress(e){}getRemotePlayerById(e){if(void 0===this.remotePlayers||0==this.remotePlayers.length)return;const t=this.remotePlayers.filter(function(t){if(t.id==e)return!0});return 0!=t.length?t[0]:void 0}animate(){const e=this,t=this.clock.getDelta();if(requestAnimationFrame(function(){e.animate()}),this.updateRemotePlayers(t),null!=this.player.mixer&&this.mode==this.modes.ACTIVE&&this.player.mixer.update(t),"Walking"==this.player.action){Date.now()-this.player.actionTime>1e3&&this.player.motion.forward>0&&(this.player.action="Running")}if(void 0!==this.player.motion&&this.player.move(t),null!=this.cameras&&null!=this.cameras.active&&void 0!==this.player&&void 0!==this.player.object){this.camera.position.lerp(this.cameras.active.getWorldPosition(new THREE.Vector3),.05);const e=this.player.object.position.clone();this.cameras.active==this.cameras.chat?e.y+=100:e.y+=150,this.camera.lookAt(e)}void 0!==this.sun&&(this.sun.position.copy(this.camera.position),this.sun.position.y+=10),void 0!==this.speechBubble&&this.speechBubble.show(this.camera.position),this.renderer.render(this.scene,this.camera)}}class Player{constructor(e,t){let i,s;this.local=!0;const o=["red","green","pink"];if(s=o[Math.floor(Math.random()*o.length)],void 0===t){const e=["hazmat","mocap"];i=e[Math.floor(Math.random()*e.length)]}else"object"==typeof t?(this.local=!1,this.options=t,this.id=t.id,i=t.model,s=t.colour):i=t;this.model=i,this.colour=s,this.game=e,this.animations=this.game.animations;const a=new THREE.FBXLoader,n=this;a.load(`https://virtual-event-space.s3-eu-west-1.amazonaws.com/${i}.fbx`,function(t){if(t.mixer=new THREE.AnimationMixer(t),n.root=t,n.mixer=t.mixer,t.name="Person",t.traverse(function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),(new THREE.TextureLoader).load(`${e.assetsPath}images/char_${i}_${s}.png`,function(e){t.traverse(function(t){t.isMesh&&(t.material.map=e)})}),n.object=new THREE.Object3D,n.object.position.set(1e3,0,0),n.object.rotation.set(0,2.6,0),n.object.add(t),void 0===n.deleted&&e.scene.add(n.object),"hazmat"==i?e.animations.hazmatIdle=t.animations[0]:e.animations.mocapIdle=t.animations[0],n.local)e.createCameras(),e.sun.target=e.player.object,void 0!==n.initSocket&&n.initSocket();else{const t=new THREE.BoxGeometry(100,300,100),i=new THREE.MeshBasicMaterial({visible:!1}),s=new THREE.Mesh(t,i);s.name="Collider",s.position.set(0,150,0),n.object.add(s),n.collider=s,n.object.userData.id=n.id,n.object.userData.remotePlayer=!0;const o=e.initialisingPlayers.splice(e.initialisingPlayers.indexOf(this),1);e.remotePlayers.push(o[0])}"hazmat"==i?void 0!==e.animations.hazmatIdle&&(n.action="Idle"):void 0!==e.animations.mocapIdle&&(n.action="Idle")})}set action(e){if(console.log(this.model+e),console.log(this.animations),this.actionName==e)return;const t=this.local?this.animations[this.model+e]:THREE.AnimationClip.parse(THREE.AnimationClip.toJSON(this.animations[this.model+e])),i=this.mixer.clipAction(t);i.time=0,this.mixer.stopAllAction(),this.actionName=e,this.actionTime=Date.now(),i.fadeIn(.5),i.play()}get action(){return this.actionName}update(e){if(this.mixer.update(e),this.game.remoteData.length>0){let e=!1;for(let t of this.game.remoteData){if(t.id!=this.id)continue;this.object.position.set(t.x,t.y,t.z);const i=new THREE.Euler(t.pb,t.heading,t.pb);this.object.quaternion.setFromEuler(i),this.action=t.action,e=!0}e||this.game.removePlayer(this)}}}class PlayerLocal extends Player{constructor(e,t){super(e,t);const i=this,s=io.connect();s.on("setId",function(e){i.id=e.id}),s.on("remoteData",function(t){e.remoteData=t}),s.on("deletePlayer",function(t){const i=e.remotePlayers.filter(function(e){if(e.id==t.id)return e});if(i.length>0){let t=e.remotePlayers.indexOf(i[0]);-1!=t&&(e.remotePlayers.splice(t,1),e.scene.remove(i[0].object))}else if(index=e.initialisingPlayers.indexOf(t.id),-1!=index){e.initialisingPlayers[index].deleted=!0,e.initialisingPlayers.splice(index,1)}}),s.on("chat message",function(t){document.getElementById("chat").style.bottom="0px";const i=e.getRemotePlayerById(t.id);e.speechBubble.player=i,e.chatSocketId=i.id,e.activeCamera=e.cameras.chat,e.speechBubble.update(t.message)}),$("#msg-form").submit(function(t){return s.emit("chat message",{id:e.chatSocketId,message:$("#m").val()}),$("#m").val(""),!1}),this.socket=s}initSocket(){this.socket.emit("init",{model:this.model,colour:this.colour,x:this.object.position.x,y:this.object.position.y,z:this.object.position.z,h:this.object.rotation.y,pb:this.object.rotation.x})}updateSocket(){void 0!==this.socket&&this.socket.emit("update",{x:this.object.position.x,y:this.object.position.y,z:this.object.position.z,h:this.object.rotation.y,pb:this.object.rotation.x,action:this.action})}move(e){const t=this.object.position.clone();t.y+=60;let i=new THREE.Vector3;this.object.getWorldDirection(i),this.motion.forward<0&&i.negate();let s=new THREE.Raycaster(t,i),o=!1;const a=this.game.colliders;if(void 0!==a){const e=s.intersectObjects(a);e.length>0&&e[0].distance<50&&(o=!0)}if(!o)if(this.motion.forward>0){const t="Running"==this.action?500:150;this.object.translateZ(e*t)}else this.object.translateZ(30*-e);if(void 0!==a){i.set(-1,0,0),i.applyMatrix4(this.object.matrix),i.normalize();let o=(s=new THREE.Raycaster(t,i)).intersectObjects(a);o.length>0&&o[0].distance<50&&this.object.translateX(100-o[0].distance),i.set(1,0,0),i.applyMatrix4(this.object.matrix),i.normalize(),(o=(s=new THREE.Raycaster(t,i)).intersectObjects(a)).length>0&&o[0].distance<50&&this.object.translateX(o[0].distance-100),i.set(0,-1,0),t.y+=200;const n=30;if((o=(s=new THREE.Raycaster(t,i)).intersectObjects(a)).length>0){const i=t.y-o[0].distance;i>this.object.position.y?(this.object.position.y=.8*this.object.position.y+.2*i,this.velocityY=0):i<this.object.position.y&&(null==this.velocityY&&(this.velocityY=0),this.velocityY+=e*n,this.object.position.y-=this.velocityY,this.object.position.y<i&&(this.velocityY=0,this.object.position.y=i))}}this.object.rotateY(this.motion.turn*e),this.updateSocket()}}class SpeechBubble{constructor(e,t,i=.5){this.config={font:"Calibri",size:18,padding:10,colour:"#fff",width:256,height:256};const s=new THREE.PlaneGeometry(i,i),o=new THREE.MeshBasicMaterial;this.mesh=new THREE.Mesh(s,o),e.scene.add(this.mesh);const a=this;(new THREE.TextureLoader).load(`${e.assetsPath}images/speech.png`,function(e){a.img=e.image,a.mesh.material.map=e,a.mesh.material.transparent=!0,a.mesh.material.needsUpdate=!0,void 0!==t&&a.update(t)},void 0,function(e){console.error("An error happened.")})}update(e){if(void 0===this.mesh)return;let t=this.context;if(void 0===this.mesh.userData.context){const e=this.createOffscreenCanvas(this.config.width,this.config.height);this.context=e.getContext("2d"),(t=this.context).font=`${this.config.size}pt ${this.config.font}`,t.fillStyle=this.config.colour,t.textAlign="center",this.mesh.material.map=new THREE.CanvasTexture(e)}const i=this.img;t.clearRect(0,0,this.config.width,this.config.height),t.drawImage(i,0,0,i.width,i.height,0,0,this.config.width,this.config.height),this.wrapText(e,t),this.mesh.material.map.needsUpdate=!0}createOffscreenCanvas(e,t){const i=document.createElement("canvas");return i.width=e,i.height=t,i}wrapText(e,t){const i=e.split(" ");let s="";const o=[],a=this.config.width-2*this.config.padding,n=this.config.size+8;i.forEach(function(e){const i=`${s}${e} `;t.measureText(i).width>a?(o.push(s),s=`${e} `):s=i}),""!=s&&o.push(s);let r=(this.config.height-o.length*n)/2;o.forEach(function(e){t.fillText(e,128,r),r+=n})}show(e){void 0!==this.mesh&&void 0!==this.player&&(this.mesh.position.set(this.player.object.position.x,this.player.object.position.y+250,this.player.object.position.z),this.mesh.lookAt(e))}}